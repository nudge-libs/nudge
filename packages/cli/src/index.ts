import type { Prompt, PromptBuilderState } from "@nudge/core";
import fg from "fast-glob";
import * as fs from "fs";
import { pathToFileURL } from "url";

type DiscoveredPrompt = {
  id: string;
  state: PromptBuilderState;
  filePath: string;
};

type GenerateOptions = {
  promptFilenamePattern?: string;
};

function isPrompt(value: unknown): value is Prompt {
  return (
    value !== null &&
    typeof value === "object" &&
    "id" in value &&
    "_state" in value
  );
}

async function discoverPrompts(
  dir: string,
  pattern: string,
): Promise<DiscoveredPrompt[]> {
  const prompts: DiscoveredPrompt[] = [];

  const files = fg.sync(pattern, {
    cwd: dir,
    absolute: true,
    ignore: ["**/node_modules/**"],
  });

  for (const filePath of files) {
    const fileUrl = pathToFileURL(filePath).href;
    const module = await import(fileUrl);

    for (const [, value] of Object.entries(module)) {
      if (isPrompt(value)) {
        prompts.push({
          id: value.id,
          state: value._state,
          filePath,
        });
      }
    }
  }

  return prompts;
}

async function generate(
  targetDir: string,
  outputPath: string,
  options: GenerateOptions = {},
) {
  const pattern = options.promptFilenamePattern ?? "**/*.prompt.{ts,js}";
  const prompts = await discoverPrompts(targetDir, pattern);

  const promptEntries: string[] = [];
  const registryEntries: string[] = [];

  for (const prompt of prompts) {
    // NOTE: For now, join strings. Later this is where LLM processing would happen
    const builtPrompt = prompt.state.join("\n");
    const escaped = JSON.stringify(builtPrompt);
    promptEntries.push(`  ${JSON.stringify(prompt.id)}: ${escaped}`);
    registryEntries.push(`    ${JSON.stringify(prompt.id)}: true;`);
  }

  const code = `// This file is auto-generated by @nudge/cli. Do not edit manually.
import { registerPrompts } from "@nudge/core";

declare module "@nudge/core" {
  interface PromptRegistry {
${registryEntries.join("\n")}
  }
}

const prompts = {
${promptEntries.join(",\n")}
} as const;

registerPrompts(prompts);
`;

  // Write TypeScript file
  fs.writeFileSync(outputPath, code, "utf-8");
  console.log(`Generated ${outputPath} with ${prompts.length} prompt(s)`);
}

export { discoverPrompts, generate };
